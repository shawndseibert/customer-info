<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Information Manager - Door & Window Services</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="theme-manager.js"></script>
</head>
<body>
    <!-- Password Protection Screen -->
    <div id="passwordScreen" class="password-screen">
        <div class="password-container">
            <div class="password-header">
                <i class="fas fa-shield-alt"></i>
                <h2>Admin Access Required</h2>
                <p>Enter password to access customer management system</p>
            </div>
            <div class="password-form">
                <input type="password" id="adminPassword" placeholder="Enter admin password" autofocus>
                <button onclick="checkPassword()" class="password-btn">
                    <i class="fas fa-unlock"></i> Access Admin
                </button>
                <div id="passwordError" class="password-error"></div>
                <div id="forgotPin" class="forgot-pin" style="display: none;">
                    <button onclick="resetTrustedDevice()" class="forgot-pin-btn">
                        <i class="fas fa-key"></i> Use Full Password Instead
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="adminContent" style="display: none;">
        <header>
            <div class="header-content">
                <div class="header-text">
                    <h1><i class="fas fa-door-open"></i> Customer Information Manager</h1>
                    <p>Door & Window Services - Professional Customer Management</p>
                </div>
                <button id="themeToggle" class="theme-toggle" title="Toggle dark/light theme">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <div class="main-content">
            <!-- Customer Form Section -->
            <section class="form-section">
                <div class="form-header">
                    <h2><i class="fas fa-user-plus"></i> Add New Customer</h2>
                    <i id="generateTestCustomer" class="fas fa-user-plus test-customer-icon" title="Click to generate test customer"></i>
                </div>
                <form id="customerForm" class="customer-form">
                    <!-- Contact Information -->
                    <div class="form-group">
                        <h3><i class="fas fa-address-card"></i> Contact Information</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="firstName">First Name *</label>
                                <input type="text" id="firstName" name="firstName" required>
                            </div>
                            <div class="form-field">
                                <label for="lastName">Last Name *</label>
                                <input type="text" id="lastName" name="lastName" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="phone">Phone Number *</label>
                                <input type="tel" id="phone" name="phone" required>
                            </div>
                            <div class="form-field">
                                <label for="email">Email Address</label>
                                <input type="email" id="email" name="email">
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="address">Property Address</label>
                            <div class="address-autocomplete-container">
                                <input type="text" id="address" name="address" placeholder="Start typing address..." autocomplete="off">
                                <div id="addressSuggestions" class="address-suggestions"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Service Requirements -->
                    <div class="form-group">
                        <h3><i class="fas fa-tools"></i> Service Requirements</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="serviceType">Service Type *</label>
                                <select id="serviceType" name="serviceType" required>
                                    <option value="">Select Service Type</option>
                                    <option value="new-doors">New Doors</option>
                                    <option value="new-windows">New Windows</option>
                                    <option value="door-replacement">Door Replacement</option>
                                    <option value="window-replacement">Window Replacement</option>
                                    <option value="door-parts">Door Replacement Parts</option>
                                    <option value="window-parts">Window Replacement Parts</option>
                                    <option value="repair">Repair Services</option>
                                    <option value="consultation">Consultation Only</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label for="priority">Priority Level</label>
                                <select id="priority" name="priority">
                                    <option value="low">Low - No Rush</option>
                                    <option value="medium" selected>Medium - Standard</option>
                                    <option value="high">High - Urgent</option>
                                    <option value="emergency">Emergency</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="productDetails">Product Details & Specifications</label>
                            <textarea id="productDetails" name="productDetails" rows="3" placeholder="Describe the doors/windows needed, materials, sizes, colors, etc."></textarea>
                        </div>
                        <div class="form-field">
                            <label for="budget">Estimated Budget Range</label>
                            <select id="budget" name="budget">
                                <option value="">Select Budget Range</option>
                                <option value="under-500">Under $500</option>
                                <option value="500-1000">$500 - $1,000</option>
                                <option value="1000-2500">$1,000 - $2,500</option>
                                <option value="2500-5000">$2,500 - $5,000</option>
                                <option value="5000-10000">$5,000 - $10,000</option>
                                <option value="over-10000">Over $10,000</option>
                            </select>
                        </div>
                    </div>

                    <!-- Project Details -->
                    <div class="form-group">
                        <h3><i class="fas fa-calendar-alt"></i> Project Timeline & Notes</h3>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="preferredDate">Preferred Start Date</label>
                                <input type="date" id="preferredDate" name="preferredDate">
                            </div>
                            <div class="form-field">
                                <label for="meetingDate">Follow-up Meeting</label>
                                <input type="datetime-local" id="meetingDate" name="meetingDate">
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="notes">Additional Notes</label>
                            <textarea id="notes" name="notes" rows="4" placeholder="Special requirements, access instructions, customer preferences, etc."></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label for="referralSource">How did they find us?</label>
                                <select id="referralSource" name="referralSource">
                                    <option value="">Select Source</option>
                                    <option value="google">Google Search</option>
                                    <option value="referral">Customer Referral</option>
                                    <option value="facebook">Facebook</option>
                                    <option value="yellowpages">Yellow Pages</option>
                                    <option value="flyer">Flyer/Advertisement</option>
                                    <option value="repeat">Repeat Customer</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label for="status">Customer Status</label>
                                <select id="status" name="status">
                                    <option value="initial">Initial Contact</option>
                                    <option value="quoted">Quote Provided</option>
                                    <option value="scheduled">Work Scheduled</option>
                                    <option value="in-progress">Work In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="follow-up">Needs Follow-up</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Customer Information
                        </button>
                        <button type="button" id="clearForm" class="btn btn-secondary">
                            <i class="fas fa-undo"></i> Clear Form
                        </button>
                    </div>
                </form>
            </section>

            <!-- Customer Records Section -->
            <section class="records-section">
                <div class="records-header">
                    <div class="records-title-section">
                        <div class="records-title-row">
                            <h2><i class="fas fa-users"></i> Customer Records</h2>
                            <button id="exportData" class="btn btn-export">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                        <div class="color-legend">
                            <div class="legend-item">
                                <div class="legend-color-bar priority-low"></div>
                                <span>Low Priority</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color-bar priority-medium"></div>
                                <span>Medium Priority</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color-bar priority-high"></div>
                                <span>High Priority</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color-bar priority-emergency"></div>
                                <span>Emergency</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="records-controls">
                    <div class="search-filter-row">
                        <div class="search-container">
                            <input type="text" id="searchInput" placeholder="Search customers..." class="search-input">
                            <i class="fas fa-search search-icon"></i>
                        </div>
                        <div class="filter-container">
                            <select id="statusFilter" class="filter-select">
                                <option value="">All Statuses</option>
                                <option value="initial">Initial Contact</option>
                                <option value="quoted">Quote Provided</option>
                                <option value="scheduled">Work Scheduled</option>
                                <option value="in-progress">Work In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="follow-up">Needs Follow-up</option>
                            </select>
                            <select id="priorityFilter" class="filter-select">
                                <option value="">All Priorities</option>
                                <option value="emergency">Emergency</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button id="importSubmissions" class="btn btn-import">
                            <i class="fas fa-upload"></i> Import QR Leads
                        </button>
                        <button id="syncGoogleSheets" class="btn btn-sheets">
                            <i class="fas fa-download"></i> Import from Google Sheets
                        </button>
                        <button id="pushToGoogleSheets" class="btn btn-sheets-push">
                            <i class="fas fa-upload"></i> Push to Google Sheets
                        </button>
                        <button id="deduplicateCustomers" class="btn btn-warning">
                            <i class="fas fa-compress-alt"></i> Remove Duplicates
                        </button>
                        <button id="removeAllLeads" class="btn btn-remove-all">
                            <i class="fas fa-trash-alt"></i> Remove All Leads
                        </button>
                    </div>
                </div>
                
                <div id="customerList" class="customer-list">
                    <!-- Customer records will be displayed here -->
                </div>
            </section>
        </div>

        <!-- Statistics Dashboard -->
        <section class="stats-section">
            <h3><i class="fas fa-chart-bar"></i> Business Overview</h3>
            
            <!-- Overall Stats -->
            <div class="stats-grid">
                <div class="stat-card clickable-stat" data-filter="" title="Click to show all customers">
                    <div class="stat-number" id="totalCustomers">0</div>
                    <div class="stat-label">Total Customers</div>
                </div>
                <div class="stat-card clickable-stat" data-filter="in-progress,scheduled" title="Click to show active projects">
                    <div class="stat-number" id="activeProjects">0</div>
                    <div class="stat-label">Active Projects</div>
                </div>
                <div class="stat-card clickable-stat" data-filter="completed" title="Click to show completed projects">
                    <div class="stat-number" id="completedProjects">0</div>
                    <div class="stat-label">Completed Projects</div>
                </div>
                <div class="stat-card clickable-stat" data-filter="follow-up" title="Click to show customers needing follow-up">
                    <div class="stat-number" id="followUpNeeded">0</div>
                    <div class="stat-label">Follow-ups Needed</div>
                </div>
            </div>

            <!-- Status Breakdown -->
            <div class="stats-subsection">
                <h4><i class="fas fa-tasks"></i> Status Breakdown</h4>
                <div class="stats-grid compact">
                    <div class="stat-card clickable-stat status-stat" data-filter="initial" title="Click to show initial contacts">
                        <div class="stat-number" id="statusInitial">0</div>
                        <div class="stat-label">Initial Contact</div>
                    </div>
                    <div class="stat-card clickable-stat status-stat" data-filter="quoted" title="Click to show quoted customers">
                        <div class="stat-number" id="statusQuoted">0</div>
                        <div class="stat-label">Quote Provided</div>
                    </div>
                    <div class="stat-card clickable-stat status-stat" data-filter="scheduled" title="Click to show scheduled work">
                        <div class="stat-number" id="statusScheduled">0</div>
                        <div class="stat-label">Work Scheduled</div>
                    </div>
                    <div class="stat-card clickable-stat status-stat" data-filter="in-progress" title="Click to show work in progress">
                        <div class="stat-number" id="statusInProgress">0</div>
                        <div class="stat-label">In Progress</div>
                    </div>
                    <div class="stat-card clickable-stat status-stat" data-filter="completed" title="Click to show completed work">
                        <div class="stat-number" id="statusCompleted">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card clickable-stat status-stat" data-filter="follow-up" title="Click to show follow-ups needed">
                        <div class="stat-number" id="statusFollowUp">0</div>
                        <div class="stat-label">Needs Follow-up</div>
                    </div>
                </div>
            </div>

            <!-- Priority Breakdown -->
            <div class="stats-subsection">
                <h4><i class="fas fa-exclamation-triangle"></i> Priority Breakdown</h4>
                <div class="stats-grid compact">
                    <div class="stat-card priority-stat emergency-priority clickable-priority" data-priority="emergency" title="Click to show emergency priority customers">
                        <div class="stat-number" id="priorityEmergency">0</div>
                        <div class="stat-label">Emergency</div>
                    </div>
                    <div class="stat-card priority-stat high-priority clickable-priority" data-priority="high" title="Click to show high priority customers">
                        <div class="stat-number" id="priorityHigh">0</div>
                        <div class="stat-label">High Priority</div>
                    </div>
                    <div class="stat-card priority-stat medium-priority clickable-priority" data-priority="medium" title="Click to show medium priority customers">
                        <div class="stat-number" id="priorityMedium">0</div>
                        <div class="stat-label">Medium Priority</div>
                    </div>
                    <div class="stat-card priority-stat low-priority clickable-priority" data-priority="low" title="Click to show low priority customers">
                        <div class="stat-number" id="priorityLow">0</div>
                        <div class="stat-label">Low Priority</div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Customer Detail Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Customer Details</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Customer details will be displayed here -->
            </div>
            <div class="modal-footer">
                <button id="editCustomer" class="btn btn-primary">Edit</button>
                <button id="deleteCustomer" class="btn btn-danger">Delete</button>
                <button id="closeModal" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Two-tier security: Full password for new devices, PIN for trusted devices
        const ADMIN_PASSWORD = 'Asdfghjkl1!'; // Full password for initial device setup
        const ADMIN_PIN = '8888'; // Quick PIN for devices already authenticated
        
        function checkPassword() {
            const inputPassword = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('passwordError');
            const isTrustedDevice = localStorage.getItem('trustedDevice') === 'true';
            
            let isValid = false;
            let authType = '';
            
            if (isTrustedDevice && inputPassword === ADMIN_PIN) {
                // Trusted device using PIN
                isValid = true;
                authType = 'PIN';
            } else if (inputPassword === ADMIN_PASSWORD) {
                // New device or full password
                isValid = true;
                authType = 'PASSWORD';
                // Mark this device as trusted for future PIN access
                localStorage.setItem('trustedDevice', 'true');
            }
            
            if (isValid) {
                // Correct credentials - show admin content
                document.getElementById('passwordScreen').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                
                // Store authentication in session (will expire when browser closes)
                sessionStorage.setItem('adminAuthenticated', 'true');
                
                // Initialize CustomerManager after admin content is visible
                setTimeout(() => {
                    matchPanelHeights();
                    if (window.initializeCustomerManager) {
                        window.initializeCustomerManager();
                    }
                }, 100);
                
                console.log(`Admin access granted via ${authType}`);
            } else {
                // Wrong credentials
                const expectedAuth = isTrustedDevice ? 'PIN (4 digits)' : 'password';
                errorDiv.textContent = `Incorrect ${expectedAuth}. Please try again.`;
                errorDiv.style.display = 'block';
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }
        
        // Check if already authenticated when page loads
        window.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('adminAuthenticated') === 'true') {
                document.getElementById('passwordScreen').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                
                // Match panel heights after content is visible and initialize CustomerManager
                setTimeout(() => {
                    matchPanelHeights();
                    if (window.initializeCustomerManager) {
                        window.initializeCustomerManager();
                    }
                }, 100);
            } else {
                // Update UI based on device trust status
                updatePasswordScreenUI();
            }
        });
        
        function updatePasswordScreenUI() {
            const isTrustedDevice = localStorage.getItem('trustedDevice') === 'true';
            const headerElement = document.querySelector('.password-header h2');
            const descElement = document.querySelector('.password-header p');
            const inputElement = document.getElementById('adminPassword');
            const forgotPinElement = document.getElementById('forgotPin');
            
            if (isTrustedDevice) {
                headerElement.textContent = 'Enter Your PIN';
                descElement.textContent = 'Enter your 4-digit PIN to access admin panel';
                inputElement.placeholder = 'Enter 4-digit PIN';
                inputElement.maxLength = 4;
                inputElement.pattern = '[0-9]{4}';
                inputElement.inputMode = 'numeric';
                forgotPinElement.style.display = 'block';
            } else {
                headerElement.textContent = 'Admin Access Required';
                descElement.textContent = 'Enter password to access customer management system';
                inputElement.placeholder = 'Enter admin password';
                inputElement.removeAttribute('maxLength');
                inputElement.removeAttribute('pattern');
                inputElement.inputMode = 'text';
                forgotPinElement.style.display = 'none';
            }
        }
        
        function resetTrustedDevice() {
            // Remove trusted device status and refresh UI
            localStorage.removeItem('trustedDevice');
            updatePasswordScreenUI();
            document.getElementById('adminPassword').value = '';
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('adminPassword').focus();
        }
        
        // Allow Enter key to submit password
        document.getElementById('adminPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // Function to match panel heights
        function matchPanelHeights() {
            const formSection = document.querySelector('.form-section');
            const recordsSection = document.querySelector('.records-section');
            
            if (formSection && recordsSection) {
                // Reset height to get natural height
                recordsSection.style.height = 'auto';
                
                // Get the natural height of the form section
                const formHeight = formSection.offsetHeight;
                
                // Set the records section to match
                recordsSection.style.height = formHeight + 'px';
            }
        }

        // Match heights when page loads and when window resizes
        window.addEventListener('load', matchPanelHeights);
        window.addEventListener('resize', matchPanelHeights);

        // Address Autocomplete System
        class AddressAutocomplete {
            constructor() {
                this.addressInput = document.getElementById('address');
                this.suggestionsContainer = document.getElementById('addressSuggestions');
                this.currentHighlight = -1;
                this.suggestions = [];
                this.debounceTimer = null;
                
                console.log('AddressAutocomplete constructor - addressInput:', this.addressInput); // Debug log
                console.log('AddressAutocomplete constructor - suggestionsContainer:', this.suggestionsContainer); // Debug log
                
                if (!this.addressInput || !this.suggestionsContainer) {
                    console.error('Address input or suggestions container not found!');
                    return;
                }
                
                // Common street names for suggestions
                this.commonStreets = [
                    'Main Street', 'Oak Street', 'First Street', 'Second Street', 'Third Street',
                    'Park Avenue', 'Washington Street', 'Lincoln Avenue', 'Maple Street', 'Cedar Street',
                    'Elm Street', 'Pine Street', 'Church Street', 'High Street', 'School Street',
                    'Spring Street', 'North Street', 'South Street', 'East Street', 'West Street',
                    'Broadway', 'Center Street', 'Mill Street', 'Union Street', 'Water Street'
                ];
                
                // Common cities and states
                this.commonCities = [
                    'Springfield', 'Franklin', 'Georgetown', 'Clinton', 'Greenville', 'Madison',
                    'Washington', 'Chester', 'Marion', 'Oxford', 'Bristol', 'Fairview', 'Salem',
                    'Kingston', 'Auburn', 'Richmond', 'Newport', 'Manchester', 'Plymouth', 'Dover'
                ];
                
                this.states = [
                    'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA',
                    'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD',
                    'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ',
                    'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC',
                    'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'
                ];
                
                this.init();
            }
            
            init() {
                this.addressInput.addEventListener('input', (e) => this.handleInput(e));
                this.addressInput.addEventListener('keydown', (e) => this.handleKeydown(e));
                this.addressInput.addEventListener('blur', () => this.hideSuggestions());
                this.addressInput.addEventListener('focus', (e) => {
                    if (e.target.value.length > 0) this.handleInput(e);
                });
            }
            
            handleInput(e) {
                const value = e.target.value.trim();
                console.log('Address input:', value); // Debug log
                
                if (value.length < 2) {
                    this.hideSuggestions();
                    return;
                }
                
                // Debounce API calls to avoid too many requests
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(async () => {
                    console.log('Generating suggestions for:', value); // Debug log
                    await this.generateSuggestions(value);
                    console.log('Generated suggestions:', this.suggestions); // Debug log
                    this.showSuggestions();
                }, 300);
            }
            
            async generateSuggestions(input) {
                this.suggestions = [];
                const inputLower = input.toLowerCase();
                console.log('Generating suggestions for input:', input); // Debug log
                
                // Get previously saved addresses
                const savedAddresses = this.getSavedAddresses();
                console.log('Saved addresses:', savedAddresses); // Debug log
                
                // Add matching saved addresses first
                savedAddresses.forEach(address => {
                    if (address.toLowerCase().includes(inputLower)) {
                        this.suggestions.push({
                            type: 'saved',
                            full: address,
                            street: address.split(',')[0],
                            cityState: address.split(',').slice(1).join(',').trim()
                        });
                    }
                });
                
                // Always generate some pattern suggestions first as backup
                this.generatePatternSuggestions(input);
                console.log('Pattern suggestions added:', this.suggestions.length); // Debug log
                
                // Try to fetch real address suggestions from Nominatim (free, no API key needed)
                if (input.length >= 3) {
                    try {
                        await this.fetchNominatimSuggestions(input);
                        console.log('Nominatim suggestions added, total:', this.suggestions.length); // Debug log
                    } catch (error) {
                        console.log('Nominatim unavailable, error:', error);
                        // Pattern suggestions already added above
                    }
                }
                
                // Limit to 8 suggestions
                this.suggestions = this.suggestions.slice(0, 8);
                console.log('Final suggestions:', this.suggestions); // Debug log
            }
            
            async fetchNominatimSuggestions(input) {
                // Use Nominatim (OpenStreetMap) free geocoding service
                const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&countrycodes=us&q=${encodeURIComponent(input)}`;
                console.log('Fetching from Nominatim:', url); // Debug log
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'User-Agent': 'CustomerInfoManager/1.0' // Nominatim requires a User-Agent
                    }
                });
                
                console.log('Nominatim response status:', response.status); // Debug log
                
                if (!response.ok) {
                    throw new Error(`Nominatim request failed with status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Nominatim data received:', data); // Debug log
                
                data.forEach(item => {
                    if (this.suggestions.length < 8) {
                        const address = this.formatNominatimAddress(item);
                        if (address.full) { // Only add if we got a valid address
                            this.suggestions.push({
                                type: 'nominatim',
                                full: address.full,
                                street: address.street,
                                cityState: address.cityState
                            });
                        }
                    }
                });
            }
            
            formatNominatimAddress(item) {
                const addr = item.address || {};
                
                // Build street address
                let street = '';
                if (addr.house_number) street += addr.house_number + ' ';
                if (addr.road) street += addr.road;
                else if (addr.street) street += addr.street;
                
                // Build city, state
                let cityState = '';
                if (addr.city) cityState += addr.city;
                else if (addr.town) cityState += addr.town;
                else if (addr.village) cityState += addr.village;
                
                if (addr.state) {
                    if (cityState) cityState += ', ';
                    cityState += addr.state;
                }
                
                if (addr.postcode) {
                    if (cityState) cityState += ' ';
                    cityState += addr.postcode;
                }
                
                const full = street + (cityState ? ', ' + cityState : '');
                
                return {
                    full: full,
                    street: street || item.display_name.split(',')[0],
                    cityState: cityState || item.display_name.split(',').slice(1, 3).join(',').trim()
                };
            }

            generatePatternSuggestions(input) {
                console.log('Generating pattern suggestions for:', input); // Debug log
                const inputLower = input.toLowerCase();
                const parts = input.split(/[,\s]+/);
                const firstPart = parts[0];
                
                // Always add a few basic suggestions for any input
                if (input.length >= 2) {
                    // If input looks like a house number + street
                    if (/^\d+/.test(firstPart)) {
                        const houseNumber = firstPart.match(/^\d+/)[0];
                        const streetPart = input.replace(/^\d+\s*/, '').toLowerCase();
                        
                        this.commonStreets.slice(0, 3).forEach(street => {
                            if (streetPart === '' || street.toLowerCase().includes(streetPart)) {
                                if (this.suggestions.length < 8) {
                                    const fullAddress = `${houseNumber} ${street}, Springfield, IL`;
                                    this.suggestions.push({
                                        type: 'pattern',
                                        full: fullAddress,
                                        street: `${houseNumber} ${street}`,
                                        cityState: `Springfield, IL`
                                    });
                                }
                            }
                        });
                    } else {
                        // If input looks like it starts with a street name or city
                        this.commonStreets.slice(0, 3).forEach(street => {
                            if (street.toLowerCase().includes(inputLower)) {
                                if (this.suggestions.length < 8) {
                                    const fullAddress = `123 ${street}, Springfield, IL`;
                                    this.suggestions.push({
                                        type: 'pattern',
                                        full: fullAddress,
                                        street: `123 ${street}`,
                                        cityState: `Springfield, IL`
                                    });
                                }
                            }
                        });
                        
                        // Also check cities
                        this.commonCities.slice(0, 3).forEach(city => {
                            if (city.toLowerCase().includes(inputLower)) {
                                if (this.suggestions.length < 8) {
                                    const fullAddress = `123 Main Street, ${city}, IL`;
                                    this.suggestions.push({
                                        type: 'pattern',
                                        full: fullAddress,
                                        street: `123 Main Street`,
                                        cityState: `${city}, IL`
                                    });
                                }
                            }
                        });
                    }
                }
                
                console.log('Pattern suggestions generated:', this.suggestions.length); // Debug log
            }
            
            showSuggestions() {
                console.log('ShowSuggestions called with:', this.suggestions.length, 'suggestions'); // Debug log
                
                if (this.suggestions.length === 0) {
                    console.log('No suggestions to show'); // Debug log
                    this.hideSuggestions();
                    return;
                }
                
                this.suggestionsContainer.innerHTML = '';
                this.suggestions.forEach((suggestion, index) => {
                    const div = document.createElement('div');
                    div.className = 'address-suggestion';
                    div.innerHTML = `
                        <div class="street">${suggestion.street || 'No street'}</div>
                        <div class="city-state">${suggestion.cityState || 'No city/state'}</div>
                    `;
                    div.addEventListener('mousedown', (e) => {
                        e.preventDefault(); // Prevent blur event
                        this.selectSuggestion(suggestion.full);
                    });
                    this.suggestionsContainer.appendChild(div);
                });
                
                console.log('Showing suggestions container'); // Debug log
                this.suggestionsContainer.style.display = 'block';
                this.currentHighlight = -1;
            }
            
            hideSuggestions() {
                setTimeout(() => {
                    this.suggestionsContainer.style.display = 'none';
                }, 150); // Small delay to allow click events
            }
            
            handleKeydown(e) {
                const suggestionElements = this.suggestionsContainer.querySelectorAll('.address-suggestion');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    this.currentHighlight = Math.min(this.currentHighlight + 1, suggestionElements.length - 1);
                    this.updateHighlight(suggestionElements);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    this.currentHighlight = Math.max(this.currentHighlight - 1, -1);
                    this.updateHighlight(suggestionElements);
                } else if (e.key === 'Enter' && this.currentHighlight >= 0) {
                    e.preventDefault();
                    this.selectSuggestion(this.suggestions[this.currentHighlight].full);
                } else if (e.key === 'Escape') {
                    this.hideSuggestions();
                }
            }
            
            updateHighlight(elements) {
                elements.forEach((el, index) => {
                    el.classList.toggle('highlighted', index === this.currentHighlight);
                });
                
                if (this.currentHighlight >= 0) {
                    elements[this.currentHighlight].scrollIntoView({ block: 'nearest' });
                }
            }
            
            selectSuggestion(address) {
                this.addressInput.value = address;
                this.hideSuggestions();
                this.saveAddress(address);
                
                // Trigger change event for any form validation
                this.addressInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
            
            saveAddress(address) {
                const saved = this.getSavedAddresses();
                if (!saved.includes(address)) {
                    saved.unshift(address);
                    // Keep only last 20 addresses
                    const limited = saved.slice(0, 20);
                    localStorage.setItem('savedAddresses', JSON.stringify(limited));
                }
            }
            
            getSavedAddresses() {
                try {
                    return JSON.parse(localStorage.getItem('savedAddresses') || '[]');
                } catch {
                    return [];
                }
            }
        }
        
        // Initialize address autocomplete when page loads
        window.addEventListener('load', () => {
            console.log('Initializing AddressAutocomplete'); // Debug log
            const autocomplete = new AddressAutocomplete();
            console.log('AddressAutocomplete initialized:', autocomplete); // Debug log
        });
        
        // Also initialize when admin content becomes visible
        function initAutocompleteWhenReady() {
            const addressInput = document.getElementById('address');
            if (addressInput && document.getElementById('adminContent').style.display !== 'none') {
                console.log('Admin content visible, initializing autocomplete'); // Debug log
                new AddressAutocomplete();
            } else {
                setTimeout(initAutocompleteWhenReady, 100);
            }
        }
    </script>
    <script src="script.js"></script>
</body>
</html>